# Watermark

Данный пример демонстрирует возможность разработки расширения для программы DVWebTool. 

## Описание примера

Представленное в примере расширение предназначено для добавления водяных знаков в PDF-файлы карточки Документ.

Пример включает три компонента:

- FileServiceServerExtension – папка с серверным расширением Web-клиента, в котором реализованы две функции:
  - предоставление бинарных данных файла из карточки файла с версиями;
  - добавление файлов в карточку Документ (с созданием карточки файла с версиями).
- WebExtension – папка с клиентским расширением, в котором реализован клиентский сервис, взаимодействующий с методами расширения FileServiceServerExtension, а также обработчик события нажатия кнопки, использующий данный клиентский сервис.
- WebToolExtension – расширение DVWebTool, в котором реализованы две функции:
  - добавление водяных знаков в файлы PDF (используется библиотека iText);
  - точка доступа к вызовам функции добавления водяных знаков.

## Настройка среды разработки

**Перечень необходимых инструментов:** 

* [Visual Studio 2017/2019](https://www.visualstudio.com)
* [NodeJS v14.17.0+](https://nodejs.org/en/)

## Сборка проекта

1. Сборка серверного расширения Web-клиента и расширения DVWebTool.
   1. Откройте решение Samples.sln.
   2. Соберите проект Other > Watermark > WatermarkServerExtension.
   3. Соберите проект Other > Watermark > WatermarkWebToolExtension.
   
3. Сборка клиентской части.

   1. Откройте в командной строке папку Others > Watermark > WatermarkWebExtension.

   2. Выполните команды:

      ```
      npm install
      npm update
      npm run build:prod
      ```

4. Публикация компонентов на сервере Web-клиент.

   1. Остановите IIS.
   2. Скопируйте папку `SamplesOutput\Site\Content\Modules\WatermarkWebExtension\` в  `<Каталог установки Web-клиента>\Site\Content\Modules`.
   3. Скопируйте папку `SamplesOutput\Site\Content\Tools\DVWebTool\Application Files\` в  `<Каталог установки Web-клиента>\Site\Content\Tools\DVWebTool\`.
   4. Скопируйте папку `SamplesOutput\Site\Extensions\WatermarkServerExtension` в  `<Каталог установки Web-клиента>\Site\Extensions`.
   5. Запустите IIS.
   
4. Регистрация расширения DvWebTool на сервере Web-клиент.

   1. Запустите программу `<Каталог установки Web-клиента>\Tools\mageui.exe`.
   2. Обновите манифест программы:
      1. Нажмите **File** → **Open** и выберите файл `<Каталог установки Web-клиента>\Site\Content\Tools\DVWebTool\Application     Files\DocsVision.DVWebTool.exe.manifest`.
      
      2. Перейдите в раздел Name и в поле Version увеличьте номер сборки. Например, «5.5.5531.0» до «5.5.5531.1». Не изменяйте мажорную и минорную версии, и версию исправления.
      
      4. Перейдите в раздел Files.
      
      5. Нажмите кнопку **Populate**. В манифест будут добавлены файлы разработанного расширения DVWebTool.
      
      6. Нажмите **File** → **Save**. Будет предложено подписать манифест.
      
      7. Нажмите **…** в поле File, выберите файл сертификата `<Каталог установки Web-клиента>/DVWebTool.pfx`, затем нажмите **OK** в основном окне подписания манифеста (пароль указывать не нужно). Файл манифеста будет подписан сертификатом *DVWebTool.pfx*.
   3. Обновите файл развертывания программы:
   
      1. Нажмите **File** → **Open** и выберите файл `<Каталог установки Web-клиента>\Site\Content\Tools\DVWebTool\DocsVision.DVWebTool.application`.
      2. Перейдите в раздел Name и в поле Version увеличьте номер сборки. Например, «5.5.5531.0» до «5.5.5531.1». Не изменяйте мажорную и минорную версии, и версию исправления.
      3. Перейдите в раздел Update option и в поле Version введите номер версии,     который был получен в разделе Name. Например, «5.5.5531.1».
      4. Перейдите в раздел Application Reference, нажмите кнопку **Select Manifest** и выберите файл `<Каталог установки Web-клиента>\Content\Tools\DVWebTool\Application Files\DocsVision.DVWebTool.exe.manifest`. В поле Version будет указана версия , полученная при обновлении файла манифеста.
      6. Нажмите **File** → **Save**. Будет предложено подписать файл развёртывания.
      7. Нажмите **…** в поле File, выберите файл сертификата `<Каталог установки Web-клиента>/DVWebTool.pfx`, затем нажмите **OK** в основном окне подписания  (пароль указывать не нужно). Файл развертывания будет подписан сертификатом *DVWebTool.pfx*.
   4. Закройте программу mageui.exe.
   5. Рекомендуется перезапустить IIS.
   

## Проверка примера

1. Настройте разметку:

   1. В Конструкторе web-разметок добавьте элемент **Кнопка** в любую разметку просмотра карточки Документ.
   2. Укажите для события «При щелчке» обработчик «addWatermark».
   3. Сохраните разметку.

2. Установите или обновите программу DvWebTool. Cм. пункт «Установка и запуск программы «DVWebTool» руководства пользователя Web-клиент.

3. Запустите программу DvWebTool. Убедитесь, что программа DvWebTool и Web-клиент будут запущены от имени одного пользователя.

4. Убедитесь, что все расширения установлены:

   1. В Web-клиенте перейдите в раздел «О программе». 

      В разделе «Подключенные расширения» должны быть указаны расширения:

      - WatermarkServerExtension - (Сборка <номер сборки>)
      - Watermark to PDF <номер сборки> (web-расширение)

   2. Откройте панель «About» из меню Docsvision DVWebTool.

      В списке установленных расширений должно быть расширение «Watermark to PDF <версия>».

5. Откройте для просмотра любую карточку с разметкой, настроенной в п. 1.

6. Добавьте один или несколько основных файлов с расширение PDF.

7. Нажмите на добавленную кнопку с обработчиком «addWatermark».

   Появится сообщение «Запущен процесс добавления водяных знаков» – начнётся процесс добавления водяных знаков.
  
   После завершения процедуры появится сообщение «Водяные знаки добавлены в файлы: <список PDF-файлов, в которые добавлены водяные знаки>».
  
   В карточку будут добавлены дополнительные файлы с постфиксом «_marked», являющиеся копиями оригинальных файлов с добавленным водяным знаком: слово «Секретно». 