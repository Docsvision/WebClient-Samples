# Watermark

Данный пример демонстрирует возможность разработки расширения для программы DVWebTool. 

## Описание примера

Представленное в примере расширение предназначено для добавления водяных знаков в PDF-файлы карточки Документ.

Пример включает три компонента:

- FileServiceServerExtension – папка с серверным расширением Web-клиента, в котором реализованы две функции:
  - предоставление бинарных данных файла из карточки файла с версиями;
  - добавление файлов в карточку Документ (с созданием карточки файла с версиями).
- WebExtension – папка с клиентским расширением, в котором реализован клиентский сервис, взаимодействующий с методами расширения FileServiceServerExtension, а также обработчик события нажатия кнопки, использующий данный клиентский сервис.
- WebToolExtension – расширение DVWebTool, в котором реализованы две функции:
  - добавление водяных знаков в файлы PDF (используется библиотека iText);
  - точка доступа к вызовам функции добавления водяных знаков.

## Настройка среды

Пример рассчитан на версию Web-клиента 18 (6.1) или выше.

**Перечень необходимых инструментов:** 

* [Visual Studio 2022](https://www.visualstudio.com)
* [NodeJS v16.20.0+](https://nodejs.org/en/)

## Сборка проекта

1. Сборка серверного расширения Web-клиента и расширения DVWebTool.
   1. Откройте решение Samples.sln.
   2. Соберите проект Other > Watermark > WatermarkServerExtension.
   3. Соберите проект Other > Watermark > WatermarkWebToolExtension.
   
2. Сборка клиентской части.

   1. Откройте в командной строке папку Others > Watermark > WatermarkWebExtension.

   2. Выполните команды:

      ```
      npm install
      npm update
      npm run build:prod
      ```

3. Публикация компонентов на сервере Web-клиент.

   1. Остановите Web-сервис.
   2. Скопируйте папку `SamplesOutput\Site\Content\Modules\WatermarkWebExtension\` в  `Путь к сайту Web-клиента\Content\Modules`.
   3. Скопируйте папку `SamplesOutput\Site\Content\Tools\DVWebTool\Application Files\` в  `Путь к папке с панелью управления Web-клиентом\Site\Content\Tools\DVWebTool\` (например `C:\Program Files (x86)\Docsvision6\WebClient\Site\Content\Tools\DVWebTool`
   4. Скопируйте папку `SamplesOutput\Site\Extensions\WatermarkServerExtension` в  `Путь к сайту Web-клиента\Extensions`.
   5. Запустите Web-сервис.
   
4. Регистрация расширения DvWebTool на сервере Web-клиент.

   1. Запустите "Docvision Панель управления Web-клиентом".
   2. Нажмите кнопку "Собрать DVWebTool"
   3. В диалоге введите адрес публикации Web-клиента, при необходимости установите другие опции, и нажмите кнопку ОК
   4. Установите собранный DvWebTool на сервер Web-клиента (см. пункт «Установка и запуск программы «DVWebTool» руководства пользователя Web-клиент).
   
5. Рекомендуется перезапустить Web-сервис.
   

## Проверка примера

1. Настройте разметку:

   1. В Конструкторе web-разметок добавьте элемент **Кнопка** в любую разметку просмотра карточки Документ.
   2. Укажите для события «При щелчке» обработчик «addWatermark».
   3. Сохраните разметку.

2. Установите или обновите программу DvWebTool. Cм. пункт «Установка и запуск программы «DVWebTool» руководства пользователя Web-клиент.

3. Запустите программу DvWebTool. Убедитесь, что программа DvWebTool и Web-клиент будут запущены от имени одного пользователя.

4. Убедитесь, что все расширения установлены:

   1. В Web-клиенте перейдите в раздел «О программе». 

      В разделе «Подключенные расширения» должны быть указаны расширения:

      - WatermarkServerExtension - (Сборка <номер сборки>)
      - Watermark to PDF <номер сборки> (web-расширение)

   2. Откройте панель «About» из меню Docsvision DVWebTool.

      В списке установленных расширений должно быть расширение «Watermark to PDF <версия>».

5. Откройте для просмотра любую карточку с разметкой, настроенной в п. 1.

6. Добавьте один или несколько основных файлов с расширением PDF.

7. Нажмите на добавленную кнопку с обработчиком «addWatermark».

   Появится сообщение «Запущен процесс добавления водяных знаков» – начнётся процесс добавления водяных знаков.
  
   После завершения процедуры появится сообщение «Водяные знаки добавлены в файлы: <список PDF-файлов, в которые добавлены водяные знаки>».
  
   В карточку будут добавлены дополнительные файлы с постфиксом «_marked», являющиеся копиями оригинальных файлов с добавленным водяным знаком: слово «Секретно». 